<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" type="text/css" href="../css/common.css" media="all">
<script language="javascript" type="text/javascript" src="../js/menu_base.js"></script>
<script language="javascript" type="text/javascript" src="../js/menu.js"></script>
<script language="javascript" type="text/javascript" src="../js/common.js"></script>
<script language="javascript" type="text/javascript" src="../js/fvt.js"></script>

<script language="javascript" type="text/javascript">

var bridgeRuleNum=0;
var bridge_ruleNum=-1;
var bridge_maxrule=16;
var untag_vid=4097;
var min_vid=0;
var max_vid=4094;

function deleteEntry(wan_mode,val)
{
	if(confirm("Are you sure you want to delete?"))
	{
		if(wan_mode == 0)
		{

		}
		else if(wan_mode ==1)
		{
			document.getElementById("id_delete_item").value=val;
			fvt_form_submit('bridgeAdd_form');
			document.getElementById("id_bridgeAdd_form").submit();
		}
	}
}

function checkName(a)
{
	if (!isBlank(a))
	{
		for(var i=0;i<a.length;i++)
		{
			c=a.charAt(i);
			if((c!='_')&&(c!='-')&&(c!='.')&&(c!='&')&&(c!='/')&&(c!='=')&&(c!='~')&&(c!='@')&&(c!='?')&&(!((c>='a')&&(c<='z')))&&(!((c>='A')&&(c<='Z')))&&(!((c>='0')&&(c<='9'))))
			{
				return c;
			}
		}
	}
	return "OK";
}

function init()
{
	for (var i=0;i<bridge_maxrule;i++)
	{
		var bridgeName;
		bridgeName = fvt_meta_config("l2_proto_vlan"+i+"_name");
		if (bridgeName=="")
		{
			bridge_ruleNum = i;
			break;
		}
	}
	if(bridge_ruleNum == -1)
	{
		document.getElementById("overBrnum").style.display="table-row";
		document.getElementById("id_Addbutton").style.visibility='hidden';
		document.getElementById("id_GUIWanName").disabled = true;
	}
	else
	{
		document.getElementById("overBrnum").style.display="none";
		document.getElementById("id_Addbutton").style.visibility='visible';
		document.getElementById("id_GUIWanName").disabled = false;
	}

		//alert(bridge_ruleNum);
}

function next()
{
	var aa,aq,ae,am,au,av,at,ai,ar,url;
	var item,syb,i,obj;
	au = 1;
	ae = "3";
	aq = document.getElementById("id_bridgeAdd_form").GUIWanName.value;
	if (aq.length==0 )
	{
		item="Rule Name";
		warn_not_empty(item);
	//	alert(item+" can't be empty.");
		return false;
	}
	if ((syb=checkName(aq))!="OK")
	{
		item="Rule Name";
		warn_CWMP_checkSyb(item,syb)
		// alert(item + " can't include special symbol ' " + syb + " '.");
		return false;
	}

	av = "0"; //GUIWanVoIP.checked
	at = "0"; //GUIWanTR069.checked
	ai = "0"; //GUIWanIGMP.checked
	ar = "0"; //GUIWanRoute.checked
	am = "";

	if (ae == 3) //bridge
	{
		aa = bridge_ruleNum;
		url = getlink_add("wan_route_bridge",aq,ae,am,av,at,ai,ar,au,aa);
	}
	var new_vlanid;
	if ( document.bridgeAdd_form.nosave_Utag[1].checked )
		new_vlanid=untag_vid;
	else
		new_vlanid=document.getElementById("id_GUIBrigeVID").value;

	window.location.href = url+"&vid="+new_vlanid;
}

function Back()
{
	window.location.href="wwwctrl.cgi?action=wan_pon_connections";
}

function Add_new_Bridge()
{
	var new_vlanid;
	if ( document.bridgeAdd_form.nosave_Utag[1].checked )
		new_vlanid=untag_vid;
	else
		new_vlanid=document.getElementById("id_GUIBrigeVID").value;

	if (!check_integer_range(new_vlanid,0,4096))
	{
		item = "VLAN ID of New Bridge";
		min = min_vid;
		max = max_vid;
		warn_int_between(item,min,max);
		return false;
	}
	if ( document.bridgeAdd_form.nosave_Utag[0].checked )
	{
		if( (new_vlanid == "") || (isBlank(new_vlanid)) )
		{
			item = "VLAN ID of New Bridge";
			msg = "Bridge-Port Base";
			warn_not_empty(item);
			return false;
		}
	}

	var Brgvlan = new Array();
	var totalvlan=0;
	for (var i=0;i<bridge_maxrule;i++)
	{
		var vlanid;
		vlanid=fvt_meta_config("l2_proto_vlan"+i+"_vlan_mark");
		if (vlanid!="")
		{
			var matchvlan = Brgvlan.indexOf(vlanid);
			if (matchvlan < 0)
			{
			Brgvlan[totalvlan] = vlanid;
			//alert(totalvlan+"="+Brgvlan[totalvlan]);
			totalvlan++;
			}
		}
	}

	for (var i=0;i<Brgvlan.length;i++)
	{
		if (Brgvlan[i]==new_vlanid)
		{
		var show_vlanid="Untag";
		if (new_vlanid!=untag_vid) show_vlanid=new_vlanid;
		alert ("This VLAN ID ["+show_vlanid+"] has been used!\n Please use another VLAN ID.");
		return false;
		}
	}

	aa=3;
	next();
}

function manual_open(item)
{
	document.getElementById("id_"+item).disabled = false;
}

function manual_close(item)
{
	document.getElementById("id_"+item).disabled = true;
}

//-->
</script>
</head>

<body align="left" onload="init();">
<table align="center" width="95%"><tbody>
<tr><td valign="top">
<div class="lv1_indent lv1_td" style="margin-left:0em;margin-top:20px">
<form id="id_bridgeAdd_form" name="bridgeAdd_form" method="post">
<fieldset>
	<div class="lv1_title">
	Advanced Setup&nbsp;&gt;&nbsp;WAN Connections&nbsp;&gt;&nbsp;Bridge Add
	</div>
</fieldset>
<div class="top_Nwanpon_2 lv3_new">

	<div class="div1_indent lv2_new">
	<table id="bridge_add" name="bridge_add" border="0"><tbody>
	<script language="javascript" type="text/javascript">
		document.write("<tr id='overBrnum'>");
		document.write("<td colspan='5' style='color:#FF0000;font-weight:bold;font-size:18px;height:65px;'>");
		document.write("Your bridge rule is already full, can not add other rule. <br>");
		document.write("( Rule count exceeded allowed maximum: "+bridge_maxrule+" )</td>");
		document.write("</tr>");
	</script>
		<tr>
			<td width="150px">Name of Rule</td>
			<td width="5px"></td>
			<td></td>
			<td></td>
			<td>
				<input ctrlflip="etc" id="id_GUIWanName" name="GUIWanName" class="width_text150" maxlength="12" type="text">
			</td>
			<td></td>
		</tr>
		<tr>
			<td nowrap>VLan ID of New Bridge</td>
			<td></td>
			<td><input type="radio" class="radio" name="nosave_Utag" id="id_nosave_Utag" value="0" onclick="manual_open('GUIBrigeVID')" checked></td>
			<td>Tag</td>
			<td width="350px">
				<input ctrlflip="etc" id="id_GUIBrigeVID" name="GUIBrigeVID" class="width_text150" maxlength="4" type="text">
				<script language="javascript" type="text/javascript">
				document.write("&nbsp;&nbsp;("+min_vid+"~"+max_vid+")");
				</script>
			</td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td>
				<input type="radio" class="radio" name="nosave_Utag" id="id_nosave_Utag" value="1" onclick="manual_close('GUIBrigeVID')">
			</td>
			<td>Untag</td>
		</tr>
		<tr></tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
			<td>
				<input ctrlflip="etc" type="button" onclick="Add_new_Bridge()" name="applybtn" value="Add Bridge" class="width_apply" id="id_Addbutton">&nbsp;&nbsp;
				<input ctrlflip="etc" type="button" onclick="Back()" name="applybtn" value="Back" class="width_apply">
			</td>
		</tr>

	</tbody></table>
	</div>

</div>
</form>

</div>

</td></tr>
</tbody></table>

</body>
</html>

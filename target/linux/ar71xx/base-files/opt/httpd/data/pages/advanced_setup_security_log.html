<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" type="text/css" href="../css/common.css" media="all">
<script language="javascript" type="text/javascript" src="../js/menu_base.js"></script>
<script language="javascript" type="text/javascript" src="../js/menu.js"></script>
<script language="javascript" type="text/javascript" src="../js/common.js"></script>
<script language="javascript" type="text/javascript" src="../js/fvt.js"></script>

<script language="javascript" type="text/javascript">

/*
var log_level_name = new Array("EMERG", "ALERT", "CRIT", "ERR", "WARNING", "NOTICE", "INFO", "DEBUG");

function Init()
{
	var i;
	var log_level=fvt_meta_config('syslogd_klogd_level');//"EMERG;ALERT;CRIT;ERR;WARNING;NOTICE;INFO;DEBUG;";

	for(i=0; i<log_level_name.length; i++)
    	{
		if(log_level.indexOf(log_level_name[i]) != -1)
			document.getElementById("id_"+log_level_name[i]).checked = true;
		else
			document.getElementById("id_"+log_level_name[i]).checked = false;
	}
}
*/

function check_process()
{
	var process="Success";
	if (process=="Existed")
		warn_wait();
		//alert("Please wait!!Another client is upgading firmware.");
}

function SetLogLevel()
{
	//var log_level="EMERG;ALERT;CRIT;ERR;WARNING;NOTICE;INFO;DEBUG;";
	document.syslog_tab_form.SyslogDisplayLevels.value="";

	for(i=0; i<log_level_name.length; i++)
	{
		if(document.getElementById("id_"+log_level_name[i]).checked == true)
		{
		    document.syslog_tab_form.SyslogDisplayLevels.value += log_level_name[i];
		    document.syslog_tab_form.SyslogDisplayLevels.value += ";";
		}
	}
}


function usershow()
{
	//SetLogLevel();

	if (document.syslog_tab_form.RemoteLogEnable.selectedIndex!=0)
	{
		merge_ip("id_RemoteLogServer","id_RemoteLogServer_item1","id_RemoteLogServer_item2","id_RemoteLogServer_item3","id_RemoteLogServer_item4");
		if((document.getElementById("id_RemoteLogServer").value == "")     ||
	        	(!check_ip(document.getElementById("id_RemoteLogServer").value)))
		{
			var item="Remote Server";
			warn_invalid(item);
			//alert("The "  + item + " is invalid!");
			return false;
		}
	}
	fvt_form_submit('syslog_tab_form',0);
	document.syslog_tab_form.submit();
}


function changeMode()
{
/*
	var val;
	if (document.syslog_tab_form.RemoteLogEnable.selectedIndex==0)
		val=true;
	else
		val=false;
	document.getElementById("id_RemoteLogServer_item1").disabled = val;
	document.getElementById("id_RemoteLogServer_item2").disabled = val;
	document.getElementById("id_RemoteLogServer_item3").disabled = val;
	document.getElementById("id_RemoteLogServer_item4").disabled = val;
	document.getElementById("id_RemoteLogServer").disabled = val;
*/
}

function Syslog()
{
	/*SetLogLevel();
	if (document.syslog_tab_form.RemoteLogEnable.selectedIndex!=0)
	{
	        merge_ip("id_RemoteLogServer","id_RemoteLogServer_item1","id_RemoteLogServer_item2","id_RemoteLogServer_item3","id_RemoteLogServer_item4");
	        if((document.getElementById("id_RemoteLogServer").value == "")     ||
	                (!check_ip(document.getElementById("id_RemoteLogServer").value)))
	        {
	                var item="Remote Server";
					warn_invalid(item);
					//alert("The "  + item + " is invalid!");
	                return false;
	        }
	}*/
//	document.syslog_tab_form.ClearLog.value = "1";
	fvt_form_submit('syslog_tab_form',1);
	document.syslog_tab_form.submit();
}

function IPnumber(IPaddress) {
    var ip = IPaddress.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);
    if(ip) {
        return (+ip[1]<<24) + (+ip[2]<<16) + (+ip[3]<<8) + (+ip[4]);
    }
    return 0x1ffffffff;
}

function IPmask(maskSize) {
    return -1 << (32 - maskSize);
}

function message_process(message)
{
	var key;
	var i;
	var dev;
	var ip;
	var mask;
	var mask_number;
	var subnet;
	var msg_from_array;
	var msg_from;
	var msg_ip_array;
	var msg_ip;
	var msg_subnet;

	/* loop for max 8 LAN */
	for (i=0; i < 8; i++) {
		/* not enabled if no dev name */
		dev=meta_config['dev_lan' + i.toString() + '_interface'];
		if (dev == '' ) {
			continue;
		}
		/* calc the subnet of LAN */
		ip=meta_config['lan' + i.toString() + '_ip'];
		mask=meta_config['lan' + i.toString() + '_netmask'];
		mask_number = IPnumber(mask);
		subnet=IPnumber(ip) & mask_number;
		/* get the 'from xxx' in the message */
		msg_from_array = message.match(/ from [^\s]+/);
		if (msg_from_array != null) {
			/* get the ip in the message */
			msg_from = msg_from_array[0];
			msg_ip_array = msg_from.match(/[^\s]+/g);
			msg_ip = msg_ip_array[1];
			/* skip non-ip */
			if (msg_ip == 'LAN' || msg_ip == 'WAN') {
				continue;
			}
			/* compare the subnet with LAN */
			msg_ip = msg_ip.replace(/^::ffff:/, '');
			msg_subnet = IPnumber(msg_ip) & mask_number;
			if (msg_subnet == subnet) {
				message=message.replace(/ from [^\s]+/, ' from LAN (' + msg_ip + ')');
			}
			else {
				message=message.replace(/ from [^\s]+/, ' from WAN (' + msg_ip + ')');
			}
		}
	}
	return message;
}

function list_seclog()
{
	var xmlhttp=false;
	var aver= Math.random();
	var theURL='wwwctrl.cgi?action=slogconf&av='+aver;
	if (window.XMLHttpRequest)
	{ // code for IE7+, Firefox, Chrome, Opera, Safari, SeaMonkey
		xmlhttp=new XMLHttpRequest();
	}
	else
	{ // code for IE6, IE5
		xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
	}
	xmlhttp.onreadystatechange=function()
	{
		if (xmlhttp.readyState==4 && xmlhttp.status==200)
		{
			//alert(xmlhttp.responseText);
		}
	}
	xmlhttp.open("GET", theURL, false);
	xmlhttp.send();

	if(xmlhttp==false)
	{
		return;
	}
	var slog=xmlhttp.responseText;
	//alert(slog);

	var slog_lines=slog.match(/[^\r\n]+/g);
	var slog_lines_length = slog_lines.length;
	//alert(slog_lines_length);
	var slog_line;
	var j=0;
	var time;
	var message;
	var start_line=0;
	if (slog_lines_length > 300) start_line=slog_lines_length-300;
	for (var i=start_line; i < slog_lines_length; i++) {
		if(i%2 == 0)
			document.write("<tr class='color_rowh'>");
		else
			document.write("<tr class='color_rown'>");
		slog_line=slog_lines[i];
		j=j+1;
		time=slog_line.substring(0, 20);
		message=slog_line.substring(20);
		message2=message_process(message);
		document.write("<td>"+j.toString()+"</td>");
		document.write("<td>"+time+"</td>");
		document.write("<td>"+message2+"</td>");
		document.write("</tr>");
	}
}

function fvt_form_init(form_name)
{
	if (form_name=='syslog_tab_form' || form_name=='*') {
		fvt_form_obj_set("syslog_tab_form", "UserShow", fvt_meta_config('kv_syslog_lines'));		//select-one
		fvt_form_obj_set("syslog_tab_form", "debugLevel", fvt_meta_config('kv_syslog_priority'));		//hidden
	}
}

function fvt_form_submit(form_name, flag) 	{
	fvt_paramlist_clear();
	if (form_name=='syslog_tab_form' || form_name=='*') {
		if(flag =="1")
			fvt_paramlist_cat_str('kv_syslog_clear', "1");		//hidden
		else
		{
			fvt_paramlist_cat_str('kv_syslog_lines', fvt_form_obj_get("syslog_tab_form", "UserShow"));		//select-one
			fvt_paramlist_cat_str('kv_syslog_priority', fvt_form_obj_get("syslog_tab_form", "debugLevel"));		//hidden
		}
	}
	fvt_paramlist_presubmit(form_name);
}
</script>
</head>

<body align="left" onload="fvt_form_init('syslog_tab_form');check_process();  changeMode();">
<div id="container">
<table align="center" width="90%"><tbody>
<tr><td valign="top">
<form id="syslog_tab_form" name="syslog_tab_form" method="post">
<div class="div1_indent">
	<fieldset>
		<div class="lv1_title">&nbsp;&nbsp;&nbsp;Maintenance&nbsp;&gt;&nbsp;Log&nbsp;&gt;&nbsp;Security Log</div>
	</fieldset>
	<!-- <div><hr class="hr2"></div> -->
	<div class="lv3_new">
		<div style="display:none">
			<table><tbody>
				<tr><td class="width_log1">
						<table><tr>
							<td><div class="lv2_new" ctrlflip="etc" ctrlid="25">Log&nbsp;Size</div></td>
							<td><div class="lv2_new">(</div></td>
							<td><div class="lv2_new" ctrlflip="etc" ctrlid="26">Lines</div></td>
							<td><div class="lv2_new">)</div></td>
							<td><div class="lv2_new size_colon">:</div></td>
						</tr></table>
					</td>
					<td ctrlflip="etc"><select name="UserShow" class="width_select80">
							<option value="50">50</option>
							<option value="100">100</option>
							<option value="500">500</option>
						</select>
					</td>
				</tr>
				<tr class=" button_center">
					<td></td>
					<td >
						<!--<input type="button" name="applybtn"  value="Apply Changes" onclick="usershow()" class="width_button">-->
						<input type="button" name="applybtn"  value="Apply Changes" onclick="usershow()" class="width_button">
					</td>
				</tr>
			</tbody></table>
		</div>
		<!-- <div><hr class="hr2"></div> -->
		<div class="lv3_new">
			<table><tbody>
			<tr>
				<th class="width_log_serial"><div class="lv2_new" ctrlflip="right" ctrlid="280">#</div></th>
				<th class="width_log_time"><div class="lv2_new" ctrlflip="right" ctrlid="281">Time</div></th>
				<th class="width_log_smsg"><div class="lv2_new" ctrlflip="right" ctrlid="283">Messages</div></th>
			</tr>
			<tr>
				<td colspan="3"><div><hr class="hr2"></div></td>
			</tr>
			<script language="javascript" type="text/javascript">
				list_seclog();
			</script>
			</tbody></table>
		</div>
        <div  class="top_cwmp2" style="display:none">
            <table><tbody>
                <tr>
                    <td  class="button_center">
                        <input name="ClearLog" value="0" type="hidden">
                        <input ctrlflip="etc" name="applybtn" value="Clear" onclick="Syslog()" type="button" class="width_clear">
                    </td>
                </tr>
            </tbody></table>
        </div>
	</div>
</div>
</form>
</td></tr>
</tbody></table>
</div>

<br>
</body>
</html>





<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" type="text/css" href="../css/common.css" media="all">
<script language="javascript" type="text/javascript" src="../js/menu_base.js"></script>
<script language="javascript" type="text/javascript" src="../js/menu.js"></script>
<script language="javascript" type="text/javascript" src="../js/common.js"></script>
<script language="javascript" type="text/javascript" src="../js/fvt.js"></script>
<script language="javascript" type="text/javascript" src="../js/jquery-1.8.3.min.js"></script>
<style>
button.width_apply{width: 200px; height:22px; text-align:center;vertical-align:text-top;}
td.stat{color: black;font-weight: bold;width: 150px;}
td.act{color: blue;font-weight: bold;}
td.disact{color: black;font-weight: bold;}
</style>

<script language="javascript" type="text/javascript">
var wan_selected;
var lan_selected;

function check_process()
{
	var process="Success";
	if (process=="Existed")
		warn_wait();
}

//if already bridge, then disable apply changes button.
function isBridgeMode()
{
	var wan_type="";
	if (wan_type=="bridge")
		document.getElementById("add_applybtn").disabled=true;
}

function setup_igmp(mode)
{
	fvt_form_submit('igmp_form',mode);
	document.igmp_form.submit();
}

function selmenu_add_option(selmenu, opt, value)
{
	var s = document.getElementById(selmenu);
	var new_option = new Option(opt,value);
	s.options.add(new_option);
}

function proxy_wan_selmenu_init()
{
	var i;
	for (i=0; i<8; i++)
	{
		if (meta_config['dev_wan'+i+'_interface'] != '')
		{
			var str=meta_config['dev_wan'+i+'_interface'];
			if (meta_config['wan'+i+'_ip_assignment'] == '2')
			{
				selmenu_add_option('id_ProxyWan', 'ppp'+i, 'ppp'+i);
			}
			else
			{
				selmenu_add_option('id_ProxyWan', str, str);
			}
		}
	}
}

function proxy_lan_selmenu_init()
{
	var i;
	for (i=0; i<8; i++)
	{
		if (meta_config['dev_lan'+i+'_interface'] != '')
		{
			var str=meta_config['dev_lan'+i+'_interface'];
			selmenu_add_option('id_ProxyLan', str, str);
		}
	}
}
function fvt_form_init(form_name)
{
	if (form_name=='igmp_form' || form_name=='*')
	{
		//document.getElementById("id_showigmp_tb").style.display="none";
		//document.getElementById("enable_pure_proxy").style.display = "none";
	}
}

function fvt_form_submit(form_name, mode)	{
	fvt_paramlist_clear();
	if (form_name=='igmp_form' || form_name=='*')
	{
		if (mode=="applyvlan")
			{
			fvt_paramlist_cat_str('igmp_us_tag_ctl', fvt_form_obj_get("igmp_form", "us_igmp_tag_ctl"));
			fvt_paramlist_cat_str('igmp_us_tci',	 fvt_form_obj_get("igmp_form", "us_igmp_tci"));
			fvt_paramlist_cat_str('igmp_ds_tag_ctl', fvt_form_obj_get("igmp_form", "ds_igmp_tag_ctl"));
			fvt_paramlist_cat_str('igmp_ds_tci',	 fvt_form_obj_get("igmp_form", "ds_igmp_tci"));
			}

		if (mode=="disable")
			{
			fvt_paramlist_cat_str('kv_igmp_mode',"disable");
			fvt_paramlist_cat_str('igmp_mode',"off");
			fvt_paramlist_cat_str('igmp_proxy0_enable',"0");
			}
		if (mode=="snoopy")
			{
			fvt_paramlist_cat_str('kv_igmp_mode',"snoopy");
			fvt_paramlist_cat_str('igmp_mode',"snoopy");
			fvt_paramlist_cat_str('igmp_proxy0_enable',"0");
			}
		if (mode=="pure_proxy")
			{
			fvt_paramlist_cat_str('kv_igmp_mode',"pure_proxy");
			fvt_paramlist_cat_str('igmp_mode',"proxy_no_snoopy");
			fvt_paramlist_cat_str('igmp_proxy0_enable',"1");
			}
		if (mode=="proxy_snoopy")
			{
			fvt_paramlist_cat_str('kv_igmp_mode',"proxy_snoopy");
			fvt_paramlist_cat_str('igmp_mode',"proxy");
			fvt_paramlist_cat_str('igmp_proxy0_enable',"1");
			}
		if (mode=="pure_proxy" || mode=="proxy_snoopy")
			{
			var proxy_wan_port = fvt_form_obj_get("igmp_form", "ProxyWan");
			var proxy_lan_port = fvt_form_obj_get("igmp_form", "ProxyLan");
			fvt_paramlist_cat_str('kv_ProxyWan', proxy_wan_port);
			fvt_paramlist_cat_str('kv_ProxyLan', proxy_lan_port);

			//var proxy_wan_port_spilt = proxy_wan_port.split(".");
			//var proxy_wan_index=proxy_wan_port_spilt[0].charAt(proxy_wan_port_spilt[0].length - 1);
			//var proxy_lan_index=proxy_lan_port.charAt(proxy_lan_port.length - 1);
			//fvt_paramlist_cat_str('igmp_proxy0_wanif', "dev_wan"+proxy_wan_index+"_interface");
			//fvt_paramlist_cat_str('igmp_proxy0_lanif', "dev_lan"+proxy_lan_index+"_interface");
			fvt_paramlist_cat_str('igmp_proxy0_wanif', proxy_wan_port);
			fvt_paramlist_cat_str('igmp_proxy0_lanif', proxy_lan_port);
			}
	}
	fvt_paramlist_presubmit(form_name);
}

function init()
{
	proxy_wan_selmenu_init();
	proxy_lan_selmenu_init();

	document.getElementById("id_us_igmp_tag_ctl").value=fvt_meta_config("igmp_us_tag_ctl");
	document.getElementById("id_us_igmp_tci").value=fvt_meta_config("igmp_us_tci");
	document.getElementById("id_ds_igmp_tag_ctl").value=fvt_meta_config("igmp_ds_tag_ctl");
	document.getElementById("id_ds_igmp_tci").value=fvt_meta_config("igmp_ds_tci");

	document.getElementById("id_ProxyWan").selectedIndex = localStorage.getItem("wan_selected");
	document.getElementById("id_ProxyLan").selectedIndex = localStorage.getItem("lan_selected");
}

function toggle_visibility(id) {
	var e = document.getElementById(id);
	//if(e.style.display == 'none' && fvt_meta_config('igmp_status')=="off")
	if(e.style.display == 'none')
		e.style.display = "inline";
	else
		e.style.display = "none";
}

function selectindex()
{
	localStorage.setItem("wan_selected", document.igmp_form.ProxyWan.selectedIndex);
	localStorage.setItem("lan_selected", document.igmp_form.ProxyLan.selectedIndex);
}
</script>
</head>

<body align="left" onload="init();">
<div id="container">
<table align="center" width="90%">
<tr><td valign="top">
<form id="id_igmp_form" name="igmp_form" method="post">
	<fieldset>
		<div class="lv1_title">
			Maintenance&nbsp;&gt;&nbsp;Utilities&nbsp;
			<a href="#" id="hidden_id" style="text-decoration: none; color:#4B0082">&gt;</a>
			&nbsp;IGMP Setup
		</div>
	</fieldset>
	<br>
<div class="top_igmp">
	<table id="igmp_status_table"></table>

	<table>
	<div class="lv5_new">
	</div>
	<tr></tr>
		<tr id='disable_igmp'>
			<td width="150px"></td>
			<td class="button_left">
				<button id="DisableIGMP" class="width_apply">Disable IGMP</button>
			</td>
			<td></td>
		</tr>
		<tr id='enable_snoopy'>
			<td></td>
			<td class="button_left">
				<button id="EnableSnooping" class="width_apply">Enable IGMP Snooping</button>
			</td>
			<td></td>
		</tr>
		<tr>
			<td></td><td><HR></td><td><HR></td>
		</tr>
		<tr id='proxy_option_wan'>
			<td></td>
			<td>Select Proxy Wan port</td>
			<td align="left">
				<select id="id_ProxyWan" name="ProxyWan" onchange="selectindex();">
				</select>
			</td>
		</tr>
		<tr id='proxy_option_lan'>
			<td></td>
			<td>Select Proxy Lan port</td>
			<td align="left">
				<select id="id_ProxyLan" name="ProxyLan" onchange="selectindex();">
				</select>
			</td>
		</tr>
		<tr id='enable_proxy_snoopy'>
			<td></td>
			<td class="button_left">
				<button id="EnableProxy" class="width_apply">Enable IGMP Proxy</button>
			</td>
			<td></td>
		</tr>
		<tr id='enable_pure_proxy'>
			<td></td>
			<td class="button_left">
				<button id="EnablePureProxy" class="width_apply">Enable Pure IGMP Proxy</button>
			</td>
			<td></td>
		</tr>
	</table>
</div>

<div class="div1_indent">

	<table border="0" cellpadding="0" cellspacing="0" id="id_showigmp_tb" style="display:none;">
		<tr><td colspan="4"><HR></td></tr>
		<tr><td width="40px"></td>
			<td width="200px">
				<div class="overview_title2">US IGMP VLAN Control</div>
			</td>
			<td width="50px">
				<input type="text" maxlength='1' size='4' name="us_igmp_tag_ctl" id="id_us_igmp_tag_ctl" value="">
			</td>
			<td>(0:Transparent, 1:Add, 2:Replace)</td>
		</tr>
		<tr><td></td>
			<td>
				<div class="overview_title2">US IGMP VLAN</div>
			</td>
			<td>
				<input type="text" maxlength='4' size='4' name="us_igmp_tci" id="id_us_igmp_tci" value="">
			</td>
			<td>(0-4095)</td>
		</tr>
		<tr><td></td>
			<td>
				<div class="overview_title2">DS IGMP VLAN Control</div>
			</td>
			<td>
				<input type="text" maxlength='1' size='4' name="ds_igmp_tag_ctl" id="id_ds_igmp_tag_ctl" value="">
			</td>
			<td>(0:Transparent, 1:Remove)</td>
		</tr>
		<tr><td></td>
			<td>
				<div class="overview_title2">DS IGMP VLAN</div>
			</td>
			<td>
				<input type="text" maxlength='4' size='4' name="ds_igmp_tci" id="id_ds_igmp_tci" value="">
			</td>
			<td>(0-4095)</td>
		</tr>
		<tr id='id_ApplyVlan'>
			<td></td>
			<td></td>
			<td class="button_left" colspan="2">
				<button id="ApplyVlan">Apply IGMP VLAN</button>
			</td>
			<td></td>
		</tr>
		</table>
</div>

</form>
</td></tr>
</table>
</div>

<br>

<script type="text/javascript">
var gv_tab_data;
var igmp_status_now;
function init_page()
{
	if ( fvt_meta_config('system_modelname') == "I-040GW")
		{
		$("#enable_pure_proxy").show();
		$("#enable_proxy_snoopy").hide();
		}
	else
		{
		$("#enable_pure_proxy").hide();
		$("#enable_proxy_snoopy").show();
		}
	$("#id_showigmp_tb").hide();

	//$("#DisableIGMP").attr("disabled", true);
	//$("#EnableSnooping").attr("disabled", false);
	//$("#EnableProxy").attr("disabled", false);
	//$("#EnablePureProxy").attr("disabled", false);
	//$("#id_ProxyWan").attr("disabled", false);
	//$("#id_ProxyLan").attr("disabled", false);
	$("#id_igmp_form :button").attr("disabled", true);
}
function do_load()
{
	//loadTableData();
	//setInterval(loadTableData, 5000);
	setIntervalLimited(function(){loadTableData();}, 5000, 3);

	$("#DisableIGMP").click(function(){setup_igmp('disable');});
	$("#EnableSnooping").click(function(){setup_igmp('snoopy');});
	$("#EnableProxy").click(function(){setup_igmp('proxy_snoopy');});
	$("#EnablePureProxy").click(function(){setup_igmp('pure_proxy');});
	$("#hidden_id").click(function(){toggle_visibility('id_showigmp_tb');});
	$("#ApplyVlan").click(function(){setup_igmp('applyvlan');});
};

function loadTableData()
{
	$.ajax({
		url: "igmp_info.cmd",
		data: {
			action: "get"
		},
		async: true,
		dataType: 'text',
		type: "POST",
		success: function (data) {
			$(".removeOnReload").remove();
			if (data && $.trim(data).length > 0) {
				gv_tab_data = eval("(" + data + ")");
				//console.info("x="+gv_tab_data);
				var tab = $("#igmp_status_table");
				var row = $("<tr class='removeOnReload'></tr>");
				var cell = $("<td>IGMP Mode:</td>");
				cell.addClass("stat");
				row.append(cell);
				igmp_status_now=gv_tab_data.status;
				var cell = $("<td>" + gv_tab_data.status + "</td>");
				if ( gv_tab_data.status=="Disabled" ) cell.addClass("disact");
				else cell.addClass("act");
				row.append(cell);
				row.appendTo(tab);
				button_set();
			} else {
				gv_tab_data = false;
			}
		},
		error: function () {
			//pop_up("error happens during load table data.", 0);
			//alert("error happens during load table data.");
		}
	})

};

function button_set()
{
	//$("#DisableIGMP").attr("disabled", false);
	//$("#EnableSnooping").attr("disabled", false);
	//$("#EnableProxy").attr("disabled", false);
	//$("#EnablePureProxy").attr("disabled", false);
	//$("#id_ProxyWan").attr("disabled", false);
	//$("#id_ProxyLan").attr("disabled", false);
	$("#id_igmp_form :button").attr("disabled", false);

	if(igmp_status_now=="Disabled")
	{
		$("#DisableIGMP").attr("disabled", true);
	}
	else if(igmp_status_now=="Snooping Mode")
	{
		$("#EnableSnooping").attr("disabled", true);
	}
	else if(igmp_status_now=="Proxy Mode")
	{
		$("#EnableProxy").attr("disabled", true);
		$("#id_ProxyWan").attr("disabled", true);
		$("#id_ProxyLan").attr("disabled", true);
	}
	else //igmp_status_now=="Pure Proxy Mode"
	{
		$("#EnablePureProxy").attr("disabled", true);
	}
}

function setIntervalLimited(callback, interval, x)
{
	for (var i = 0; i < x; i++)
	{
		setTimeout(callback, i * interval);
    }
}

</script>
<script type="text/javascript">
$(document).ready(function() {
		init_page();
		do_load();
});
</script>

</body>
</html>

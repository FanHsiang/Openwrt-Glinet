<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" type="text/css" href="../css/common.css" media="all">
<script language="javascript" type="text/javascript" src="../js/menu_base.js"></script>
<script language="javascript" type="text/javascript" src="../js/menu.js"></script>
<script language="javascript" type="text/javascript" src="../js/common.js"></script>
<script language="javascript" type="text/javascript" src="../js/fvt.js"></script>


<script language="javascript" type="text/javascript">
var countZero = 0;

var i,j,k;
var NodeLength=0;
var route_max = 20
var wan_max = 8;
function getnodelength()
{
	for (i=0;i<route_max;i++)
	{
		if(fvt_meta_config("sroute_if"+i) =='')
		{
			NodeLength=i;
			return;
		}
	}
}

function faceinter()
{
	var ifname,iftype;
	//document.write("<option value='LAN'>LAN</option>");
	for (k=0;k<wan_max;k++)
	{
		if(fvt_meta_config("wan"+k+"_if_name") != '')
		{
			iftype = fvt_meta_config("wan"+k+"_ip_assignment");
			ifname = fvt_meta_config("wan"+k+"_if_name");
			ifinter = fvt_meta_config("dev_wan"+k+"_interface");
			document.write("<option value='"+ifinter+"'>"+ifinter+"("+ifname+")</option>");
		}
	}
	if(fvt_meta_config("dev_lan0_interface") != '')
	{
		ifinter = fvt_meta_config("dev_lan0_interface");
		document.write("<option value='"+ifinter+"'>"+ifinter+"(Lan)</option>");
	}
}

function check_process()
{
	var process="Success";
	if (process=="Existed")
		alert("Please wait!!Another client is upgading firmware.");
}
function isBridgeMode()
{
        var wan_type="";
        if (wan_type=="bridge")
                document.getElementById("add_applybtn").disabled=true;
}
function check_route_gateway(gw,dev)
{
	var n;
	var m;
	var o;
	var i;

	if ((gw.length > 0)&&(dev == "0")&&(gw!="0.0.0.0"))
	{
		for(i=0;i<NodeLength;i++)
		{
			var DestIP = document.getElementById("id_StaticRouteIP" + (i + 1)).value;
			var IP_Mask = document.getElementById("id_StaticRouteNetmask" + (i + 1)).value;
			var lan_ip = DestIP;
			var lan_mask = IP_Mask;
			n = lan_ip.split('.');
			m = lan_mask.split('.');
			o = gw.split('.');
			if (o.length==4)
			{
				for (i=3;i>=0;i--)
				{
					if ((m[i] & n[i])!=(m[i] & o[i]))
						return false;
				}
			}
			else
				return false;
		}
	}
	return true;
}

function check_route_ip(ip,netmask)
{
	var i;
	var n;
	var m;

	if(ip.length > 0)
	{
		n = ip.split('.');
		m = netmask.split('.');
		if(n.length == 4)
		{
			if(n[0]==127)
				return false;

			if((isNaN(n[0]))||(n[0]<1)||(n[0]>=224)||(isBlank(n[0]))||(isInitialZero(n[0]))||(!check_integer(n[0])))
				return false;

			if((isNaN(n[1]))||(n[1]<0)||(n[1]>=255)||isBlank(n[1])||(isInitialZero(n[1]))||(!check_integer(n[1])))
				return false;

			if((isNaN(n[2]))||(n[2]<0)||(n[2]>=255)||isBlank(n[2])||(isInitialZero(n[2]))||(!check_integer(n[2])))
				return false;

			if((isNaN(n[3]))||(n[3]<0)||(n[3]>=255)||isBlank(n[3])||(isInitialZero(n[3]))||(!check_integer(n[3])))
				return false;

			for (i=3;i>=0;i--)
			{
				if (m[i]!=255)
				{
					if ((m[i] & n[i])!=n[i])
						return false;
				}
				//else if (n[i]==0 && m[i]!=0)
				//		return false;
				else
					return true;
			}
		}
		else
		{
			return false;
		}
	}
	return true;
}

function check_route()
{
	var i, j;
	var msg;
	var no;
	for(i = 0; i < route_max; i++)
	{
		var Dest_item = "id_StaticRouteIP" + (i + 1);
		var value1 = "id_RouteIP" + (i + 1) + "_item1";
		var value2 = "id_RouteIP" + (i + 1) + "_item2";
		var value3 = "id_RouteIP" + (i + 1) + "_item3";
		var value4 = "id_RouteIP" + (i + 1) + "_item4";
		merge_ip(Dest_item, value1, value2, value3, value4);

		var Gw_item = "id_StaticRouteGateway" + (i + 1);
		value1 = "id_GW" + (i + 1) + "_item1";
		value2 = "id_GW" + (i + 1) + "_item2";
		value3 = "id_GW" + (i + 1) + "_item3";
		value4 = "id_GW" + (i + 1) + "_item4";
		merge_ip(Gw_item, value1, value2, value3, value4);
	}

	for(i = 0; i < route_max; i++)
	{
		var obj1=document.getElementById("id_StaticRouteIP" + (i + 1));
		var obj2=document.getElementById("id_StaticRouteNetmask" + (i + 1));
		var obj3=document.getElementById("id_StaticRouteGateway" + (i + 1));
		var obj4=document.getElementById("id_StaticRouteMetric" + (i + 1));
		var obj5=document.getElementById("id_StaticRouteInterface" + (i + 1));
		if((obj1.value !="") && (obj3.value != "") && (obj4.value != ""))
		{
			if((obj1.value!="" && obj3.value=="") || (obj1.value=="" && obj3.value!="") ||
				(obj1.value=="" && obj3.value=="" && obj4.value!=""))
			{
				alert("Group " + (i+1) + " rule incomplete");
				return false;
			}

			else if( (obj1.value=="") &&
					 (obj3.value=="") &&
					 (obj4.value!=""))
			{
				alert("Group " + (i+1) + " rule incomplete");
				return false;
			}

			else if( !((obj1.value=="")&&(obj2.value=="")) )
			{
				if ( !check_route_ip(obj1.value,obj2.value) )
				{
					msg="IP Destination";
					no=(i+1);
					alert(msg + " of group " + no + " is invalid");
					return false;
				}

				if ( !check_gateway(obj3.value) )
				{
					msg="Gateway";
					no=(i+1);
					alert(msg + " of group " + no + " is invalid");
					return false;
				}

				if ( !check_route_gateway(obj3.value,obj5.value) )
				{
					msg="Gateway";
					no=(i+1);
					//alert("msg + " of Gruop" + no + " is invalid");
					alert(msg + " of group " + no + " is invalid");
					return false;
				}

				if ( !check_integer_range(obj4.value, 1, 9999) )
				{
					no=i+1;
					alert("Metric of group " + no + " is invalid");
					return false;
				}
			}

			if(NodeLength < (i+1))
			{
				document.getElementById("id_new_Entry"+(i+1)).value = i+1;
			}
		}
	}

	for(i = 0; i < route_max; i++)
	{
		var obj1=document.getElementById("id_StaticRouteIP" + (i + 1));
        var obj2=document.getElementById("id_StaticRouteNetmask" + (i + 1));
		if(obj1.value!="")
		{
			// check IP Destination value is valid or not
			var SRIP_split=obj1.value.split(".");
			var SRNetmask_split=obj2.value.split(".");
			var SRIP_net ="";
			for(nn = 0; nn < 4; nn++)
			{
				if ( nn < 3 )SRIP_net= SRIP_net + (SRIP_split[nn] & SRNetmask_split[nn]) + '.';
				else SRIP_net = SRIP_net + (SRIP_split[nn] & SRNetmask_split[nn]);
			}
			if(obj1.value!=SRIP_net)
			{
				alert("Rule (" + (i+1) + ") IP Destination " + obj1.value + " is wrong, Please change to "+ SRIP_net);
				return false;
			}
			for(j = i + 1; j <route_max; j++)
			{
				var obj3=document.getElementById("id_StaticRouteIP" + (j + 1));
		        var obj4=document.getElementById("id_StaticRouteNetmask" + (j + 1));
				if(obj1.value!="")
				{
					if( (obj1.value==obj3.value) &&
					    (obj2.value==obj4.value)    )
					{
						alert("Routing rule of group "+ (i+1) +" and group " + (j+1)  +" are the same");
						return false;
					}
				}
			}
		}
	}
	//alert("After applying changes,you shall reboot it.");
	fvt_form_submit('route_form');
	document.route_form.submit();
}

function IPNetMask()
{
	document.write("<option value='255.255.255.255'>255.255.255.255</option>");
	document.write("<option value='255.255.255.254'>255.255.255.254</option>");
	document.write("<option value='255.255.255.252'>255.255.255.252</option>");
	document.write("<option value='255.255.255.248'>255.255.255.248</option>");
	document.write("<option value='255.255.255.240'>255.255.255.240</option>");
	document.write("<option value='255.255.255.224'>255.255.255.224</option>");
	document.write("<option value='255.255.255.192'>255.255.255.192</option>");
	document.write("<option value='255.255.255.128'>255.255.255.128</option>");
	document.write("<option value='255.255.255.0'>255.255.255.0</option>");
	document.write("<option value='255.255.254.0'>255.255.254.0</option>");
	document.write("<option value='255.255.252.0'>255.255.252.0</option>");
	document.write("<option value='255.255.248.0'>255.255.248.0</option>");
	document.write("<option value='255.255.240.0'>255.255.240.0</option>");
	document.write("<option value='255.255.224.0'>255.255.224.0</option>");
	document.write("<option value='255.255.192.0'>255.255.192.0</option>");
	document.write("<option value='255.255.128.0'>255.255.128.0</option>");
	document.write("<option value='255.255.0.0'>255.255.0.0</option>");
	document.write("<option value='255.254.0.0'>255.254.0.0</option>");
	document.write("<option value='255.252.0.0'>255.252.0.0</option>");
	document.write("<option value='255.248.0.0'>255.248.0.0</option>");
	document.write("<option value='255.240.0.0'>255.240.0.0</option>");
	document.write("<option value='255.224.0.0'>255.224.0.0</option>");
	document.write("<option value='255.192.0.0'>255.192.0.0</option>");
	document.write("<option value='255.128.0.0'>255.128.0.0</option>");
	document.write("<option value='255.0.0.0'>255.0.0.0</option>");
	document.write("<option value='254.0.0.0'>254.0.0.0</option>");
	document.write("<option value='252.0.0.0'>252.0.0.0</option>");
	document.write("<option value='248.0.0.0'>248.0.0.0</option>");
	document.write("<option value='240.0.0.0'>240.0.0.0</option>");
	document.write("<option value='224.0.0.0'>224.0.0.0</option>");
	document.write("<option value='192.0.0.0'>192.0.0.0</option>");
	document.write("<option value='128.0.0.0'>128.0.0.0</option>");
}

function show(val)
{
	for(val=1;val<=NodeLength;val++)
	{
		//DestIPAddress
		document.getElementById("id_RouteIP"+val+"_item1").value = document.getElementById("id_hidden_Dest_item1_" + val).value;
		document.getElementById("id_RouteIP"+val+"_item2").value = document.getElementById("id_hidden_Dest_item2_" + val).value;
		document.getElementById("id_RouteIP"+val+"_item3").value = document.getElementById("id_hidden_Dest_item3_" + val).value;
		document.getElementById("id_RouteIP"+val+"_item4").value = document.getElementById("id_hidden_Dest_item4_" + val).value;

		//DestSubnetMask
		document.getElementById("id_StaticRouteNetmask" + val).value = document.getElementById("id_hidden_Mask" + val).value;


		//GatewayIPAddress
		document.getElementById("id_GW"+val+"_item1").value = document.getElementById("id_hidden_GW_item1" + val).value;
		document.getElementById("id_GW"+val+"_item2").value = document.getElementById("id_hidden_GW_item2" + val).value;
		document.getElementById("id_GW"+val+"_item3").value = document.getElementById("id_hidden_GW_item3" + val).value;
		document.getElementById("id_GW"+val+"_item4").value = document.getElementById("id_hidden_GW_item4" + val).value;

		//ForwardingMetric
		document.getElementById("id_StaticRouteMetric"+val).value = document.getElementById("id_hidden_Metric" + val).value;

		//Interface
		document.getElementById("id_StaticRouteInterface" + val).value = document.getElementById("id_hidden_IF" + val).value;

		//Enable
		document.getElementById("id_StaticRouteEnable" + val).value = document.getElementById("id_hidden_en" + val).value;


	}
	//DynamicRouting
	document.getElementById("id_RIPEnable").value = document.getElementById("id_hidden_DynRt").value;

}
function list_static_route()
{
	var m;
	getnodelength();
	for(m=1;m<=route_max;m++)
	{
		var i=m-1;
		document.write("<tr><td ctrlflip='etc'>");
		document.write("<input type='hidden' name='new_Entry"+m+"' id='id_new_Entry"+m+"' value=''>");
		var ip=fvt_meta_config("sroute_ip"+i);
		var gw=fvt_meta_config("sroute_gateway"+i);
		if (ip != '')
			var ip_split=ip.split(".");
		else
		{
			var ip_split = new Array();
			ip_split[0] = '';
			ip_split[1] = '';
			ip_split[2] = '';
			ip_split[3] = '';
		}
		document.write("<input type='hidden' name='StaticRouteIP"+m+"' id='id_StaticRouteIP"+m+"' size='12' maxlength='15' value=''>");
		document.write("<input  type='text' id='id_RouteIP"+m+"_item1' class='width_ip' value='"+ip_split[0]+"' size='2' maxlength='3' >.");
		document.write("<input type='text' id='id_RouteIP"+m+"_item2' class='width_ip' value='"+ip_split[1]+"' size='2' maxlength='3'>.");
		document.write("<input type='text' id='id_RouteIP"+m+"_item3' class='width_ip' value='"+ip_split[2]+"' size='2' maxlength='3'>.");
		document.write("<input type='text' id='id_RouteIP"+m+"_item4' class='width_ip' value='"+ip_split[3]+"' size='2' maxlength='3'>");
		document.write("</td>");

		document.write("<td align='center'>");
		document.write("<select ctrlflip='etc' name='StaticRouteNetmask"+m+"' value='' class='width_selectip' id='id_StaticRouteNetmask"+m+"'>");
		IPNetMask();
		if (ip != '' && gw != '')
			document.getElementById("id_StaticRouteNetmask"+m).value =fvt_meta_config('sroute_netmask'+i);
		else
			document.getElementById("id_StaticRouteNetmask"+m).value ="255.255.255.0";
		document.write("</select>");
		document.write("</td>");

		document.write("<td align='center' ctrlflip='etc'>");
		if (gw != '')
			var gw_split=gw.split(".");
		else
		{
			var gw_split = new Array();
			gw_split[0] = '';
			gw_split[1] = '';
			gw_split[2] = '';
			gw_split[3] = '';
		}
		document.write("<input type='hidden' name='StaticRouteGateway"+m+"' id='id_StaticRouteGateway"+m+"' size='12' maxlength='15' value=''>");
		document.write("<input type='text' id='id_GW"+m+"_item1' class='width_ip' value='"+gw_split[0]+"' size='2' maxlength='3'>.");
		document.write("<input type='text' id='id_GW"+m+"_item2' class='width_ip' value='"+gw_split[1]+"' size='2' maxlength='3'>.");
		document.write("<input type='text' id='id_GW"+m+"_item3' class='width_ip' value='"+gw_split[2]+"' size='2' maxlength='3'>.");
		document.write("<input type='text' id='id_GW"+m+"_item4' class='width_ip' value='"+gw_split[3]+"' size='2' maxlength='3'>");
		document.write("</td>");

		document.write("<td align='center'>");
		var metric=fvt_meta_config("sroute_metric"+i);
		document.write("<input ctrlflip='etc' type='text' name='StaticRouteMetric"+m+"' id='id_StaticRouteMetric"+m+"' value='"+metric+"' class='width_routeS_mtxt' maxlength='4'>");
		document.write("</td>");

		document.write("<td align='center'>");
		document.write("<select ctrlflip='etc' class='width_routeS_selectif' name='StaticRouteInterface"+m+"' value='' class='width_select80' id='id_StaticRouteInterface"+m+"'>");
		faceinter();
		//if (ip != '' && gw != '')
			document.getElementById("id_StaticRouteInterface"+m).value =fvt_meta_config('sroute_if'+i);
		//else
		//	document.getElementById("id_StaticRouteInterface"+m).value ="LAN";
		document.write("</select>");
		document.write("</td>");

		document.write("<td align='center'>");
		document.write("<select ctrlflip='etc'  name='StaticRouteEnable"+m+"' value=''  id='id_StaticRouteEnable"+m+"'>");
		document.write("<option value='0'>Disable</option>");
		document.write("<option value='1'>Enable</option>");
		document.write("</select>");
		document.write("</td>");

		document.write("</tr>");
	}
}

function fvt_form_init(form_name)
{
	var i;
	if (form_name=='route_form' || form_name=='*') {
		for (i=0;i<route_max;i++)
		{
			var j=i+1;
			//fvt_form_obj_set("route_form", "new_Entry1", fvt_meta_config(''));		//hidden
			fvt_form_obj_set("route_form", "StaticRouteIP"+j, fvt_meta_config("sroute_ip"+i));		//hidden
			fvt_form_obj_set("route_form", "StaticRouteNetmask"+j, fvt_meta_config("sroute_netmask"+i));		//select-one
			fvt_form_obj_set("route_form", "StaticRouteGateway"+j, fvt_meta_config("sroute_gateway"+i));		//hidden
			fvt_form_obj_set("route_form", "StaticRouteMetric"+j, fvt_meta_config("sroute_metric"+i));		//text
			fvt_form_obj_set("route_form", "StaticRouteInterface"+j, fvt_meta_config("sroute_if"+i));		//select-one
			fvt_form_obj_set("route_form", "StaticRouteEnable"+j, fvt_meta_config("sroute_enable"+i));		//select-one
		}
		fvt_form_obj_set("route_form", "RIPEnable", fvt_meta_config('rip_enable'));		//select-one
		//fvt_form_obj_set("route_form", "default_gw", fvt_meta_config(''));		//hidden
	}
}

function fvt_form_submit(form_name) 	{
	var i;
	fvt_paramlist_clear();
	if (form_name=='route_form' || form_name=='*') {
		for (i=0; i<route_max; i++)
		{
			var j=i+1;
			//fvt_paramlist_cat_str('', fvt_form_obj_get("route_form", "new_Entry1"));		//hidden
			if (fvt_form_obj_get("route_form", "StaticRouteIP"+j) != '')
			{
				fvt_paramlist_cat_str("sroute_ip"+i, fvt_form_obj_get("route_form", "StaticRouteIP"+j));		//hidden
				fvt_paramlist_cat_str("sroute_netmask"+i, fvt_form_obj_get("route_form", "StaticRouteNetmask"+j));		//select-one
				fvt_paramlist_cat_str("sroute_gateway"+i, fvt_form_obj_get("route_form", "StaticRouteGateway"+j));		//hidden
				fvt_paramlist_cat_str("sroute_metric"+i, fvt_form_obj_get("route_form", "StaticRouteMetric"+j));		//text
				fvt_paramlist_cat_str("sroute_if"+i, fvt_form_obj_get("route_form", "StaticRouteInterface"+j));		//select-one
				fvt_paramlist_cat_str("sroute_enable"+i, fvt_form_obj_get("route_form", "StaticRouteEnable"+j));		//select-one
			}
			else if( fvt_form_obj_get("route_form", "StaticRouteIP"+j) =='' &&
					fvt_form_obj_get("route_form", "StaticRouteGateway"+j) =='' &&
					fvt_form_obj_get("route_form", "StaticRouteMetric"+j) ==''
				)
			{
				fvt_paramlist_cat_str("sroute_ip"+i, fvt_form_obj_get("route_form", "StaticRouteIP"+j));		//hidden
				fvt_paramlist_cat_str("sroute_netmask"+i, "255.255.255.255");		//select-one
				fvt_paramlist_cat_str("sroute_gateway"+i, fvt_form_obj_get("route_form", "StaticRouteGateway"+j));		//hidden
				fvt_paramlist_cat_str("sroute_metric"+i, fvt_form_obj_get("route_form", "StaticRouteMetric"+j));		//text
				fvt_paramlist_cat_str("sroute_if"+i, fvt_form_obj_get("route_form", "StaticRouteInterface"+j));		//select-one
				fvt_paramlist_cat_str("sroute_enable"+i, 0);		//select-one
			}
		}
		fvt_paramlist_cat_str('rip_enable', fvt_form_obj_get("route_form", "RIPEnable"));		//select-one
		//fvt_paramlist_cat_str('', fvt_form_obj_get("route_form", "default_gw"));		//hidden
	}
	fvt_paramlist_presubmit(form_name);
}

// convert integer to 8-digit binary ex; 127 -> 01111111
function int2bin8(a){
	var bin8;
	bin8=(a >>> 0).toString(2);
	for (i=(bin8.length); i<8; i++) bin8='0'+bin8;
	return bin8;
}
</script>
</head>

<body align="left" onload="fvt_form_init('route_form');check_process();isBridgeMode();">
<div id="container">
<table align="center" width="90%"><tbody>
<tr><td valign="top">
<form id="id_route_form" name="route_form" method="post">
	<fieldset>
		<div class="lv1_title">Advanced Setup&nbsp;&gt;&nbsp;Route Settings</div>
	</fieldset>
<div class="lv2_new lv1_indent">
	<div><hr class="hr2" /></div>
	<div class="lv1_new div1_topbottom" ctrlflip="right" ctrlid="254">Static Routing</div>
	<div>
	    <table><tbody>
			<tr><th class="width_routeS_ipD"><div class=" lv2_new" ctrlflip="etc" ctrlid="255">IP Destination</div></th>
				<th class="width_routeS_ipN"><div class=" lv2_new" ctrlflip="etc" ctrlid="236">IP Netmask</div></th>
				<th class="width_routeS_gw"><div class=" lv2_new" ctrlflip="etc" ctrlid="34">Gateway</div></th>
				<th class="width_routeS_m"><div class=" lv2_new" ctrlflip="etc" ctrlid="256">Metric</div></th>
				<th class="width_routeS_iface"><div class=" lv2_new" ctrlflip="etc" ctrlid="257">interface</div></th>
				<th class="width_routeS_en"><div class=" lv2_new" ctrlflip="etc" ctrlid="257">Enable</div></th>
			</tr>
			<tr style="height:5px">
				<td colspan="6">
					<div><hr class="hr2" /></div>
				</td>
			</tr>
			<script language="javascript" type="text/javascript">
				list_static_route();
			</script>
		</tbody></table>
	</div>
	<div><hr class="hr2" /></div>
	<div style="display:none">
		<table><tbody>
			<tr><td class="width_routeS_2"><div ctrlflip='right' ctrlid="258">Dynamic Routing</div></td>
				<td>
					<select ctrlflip="etc" name="RIPEnable" id="id_RIPEnable" class="width_select80">
						<option value="0">Disable</option>
						<option value="RIPv1">RIP1</option>
						<option value="RIPv2">RIP2</option>
						<option value="RIPv1_RIPv2">RIP1 &amp; RIP2</option>
					</select>
				</td>
			</tr>
		</tbody></table>
	</div>
	<div class="top_cwmp2">
		<table><tbody>
			<tr>
				<td class="button_center">
					<input ctrlflip="etc" name="applybtn" id="add_applybtn" value="Apply Changes" class="width_apply" onclick="check_route()" type="button">
				</td>
				<input name="default_gw" value="" type="hidden">
			</tr>
		</tbody></table>
	</div>
</div>
</form>
</td></tr>
</tbody></table>
</div>

<br>
</body>
</html>
